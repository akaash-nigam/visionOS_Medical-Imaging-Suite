name: Medical Imaging Suite CI

on:
  push:
    branches: [ main, develop, 'claude/**' ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  SCHEME: MedicalImagingSuite
  DESTINATION: 'platform=visionOS Simulator,name=Apple Vision Pro'

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: macos-14
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Cache derived data
        uses: actions/cache@v3
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-derived-data-${{ hashFiles('**/*.swift') }}
          restore-keys: |
            ${{ runner.os }}-derived-data-

      - name: Run unit tests
        run: |
          xcodebuild test \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.DESTINATION }}" \
            -only-testing:MedicalImagingSuiteTests \
            -enableCodeCoverage YES \
            -resultBundlePath TestResults.xcresult \
            | xcpretty

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-results
          path: TestResults.xcresult

  integration-tests:
    name: Integration Tests
    runs-on: macos-14
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run integration tests
        run: |
          xcodebuild test \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.DESTINATION }}" \
            -only-testing:MedicalImagingSuiteTests/Integration \
            -enableCodeCoverage YES \
            -resultBundlePath IntegrationResults.xcresult \
            | xcpretty

      - name: Upload integration results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: integration-test-results
          path: IntegrationResults.xcresult

  code-coverage:
    name: Code Coverage
    runs-on: macos-14
    needs: [unit-tests, integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Run tests with coverage
        run: |
          xcodebuild test \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.DESTINATION }}" \
            -enableCodeCoverage YES \
            -resultBundlePath CoverageResults.xcresult

      - name: Generate coverage report
        run: |
          xcrun xccov view --report CoverageResults.xcresult > coverage.txt
          xcrun xccov view --report --json CoverageResults.xcresult > coverage.json

      - name: Extract coverage percentage
        id: coverage
        run: |
          COVERAGE=$(xcrun xccov view --report CoverageResults.xcresult | grep "MedicalImagingSuite.app" | awk '{print $4}')
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Code Coverage: $COVERAGE"

      - name: Check coverage threshold
        run: |
          COVERAGE_NUM=$(echo "${{ steps.coverage.outputs.coverage }}" | sed 's/%//')
          if (( $(echo "$COVERAGE_NUM < 80.0" | bc -l) )); then
            echo "::warning::Code coverage (${{ steps.coverage.outputs.coverage }}) is below 80% threshold"
          else
            echo "::notice::Code coverage (${{ steps.coverage.outputs.coverage }}) meets 80% threshold"
          fi

      - name: Upload coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: |
            coverage.txt
            coverage.json

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = '${{ steps.coverage.outputs.coverage }}';
            const body = `## Code Coverage Report

            **Coverage**: ${coverage}
            **Threshold**: 80%
            **Status**: ${coverage.replace('%', '') >= 80 ? '✅ Passing' : '⚠️ Below threshold'}

            <details>
            <summary>View Details</summary>

            Download the full coverage report from the workflow artifacts.

            </details>`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  lint:
    name: SwiftLint
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: brew install swiftlint

      - name: Run SwiftLint
        run: |
          swiftlint lint --reporter github-actions-logging

  build:
    name: Build for visionOS
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_15.2.app

      - name: Build for visionOS
        run: |
          xcodebuild build \
            -scheme "${{ env.SCHEME }}" \
            -destination "${{ env.DESTINATION }}" \
            | xcpretty

  test-summary:
    name: Test Summary
    runs-on: macos-14
    needs: [unit-tests, integration-tests, code-coverage, lint, build]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Integration Tests | ${{ needs.integration-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Coverage | ${{ needs.code-coverage.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Fail if any job failed
        if: |
          needs.unit-tests.result == 'failure' ||
          needs.integration-tests.result == 'failure' ||
          needs.build.result == 'failure'
        run: exit 1
